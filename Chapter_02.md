# 第二章 高性能负载均衡

## 2.0 介绍

今天的互联网用户体验需要性能和正常运行时间。为了实现这一点，需要运行同一个系统的多个副本，并将负载分配到它们上面。随着负载的增加，部署系统的另一个副本联机处理请求的这种构架技术称为**水平扩展**。基于软件的基础架构因其灵活性而越来越受欢迎，从而开辟了广阔的可能性。无论用例是小到两个高可用性用例的集合，还是大到全球范围内的数千个用例。需要一种与基础架构一样动态的负载均衡解决方案。NGINX以多种方式满足了这一需求，如HTTP、TCP和UDP负载平衡，我们将在本章中介绍。

在均衡负载时，对客户的影响只是积极的影响，这一点很重要。许多现代web架构采用无状态的应用程序层，将状态存储在共享内存或数据库中，但这并不是所有人都可以实现的。在交互式应用程序中，会话状态非常重要并且使用广泛，出于多种原因，此状态可能存储在应用服务器的本地。比如，在大数据处理的应用程序中，网络开销在性能上太昂贵，因此将会话状态存储在本地应用服务器上对于用户体验来说是非常有必要的。这种情况的另一个方面是，在会话完成之前不应释放服务器。大规模的有状态应用程序需要智能负载均衡器。NGINX Plus通过跟踪cookie或路由提供了多种方法来解决这个问题。本章讨论了与NGINX和NGINX Plus负载均衡相关的会话持久性。

确保NGINX服务的应用程序运行良好同样重要。由于多种原因，应用程序可能宕机。比如由于网络连接性，服务器故障或应用程序故障等。代理和负载均衡器必须足够智能，以检测上游服务器的故障并停止向它们传递流量，不然，客户端将被等待，得到一个超时错误。减轻服务器质量下降的一种方法是让代理检查上游服务器的健康状况。NGINX提供两种不同类型的健康检查：被动式，在开源版本中可用；主动式，只有在NGINX Plus中可用。主动式为定期与上游服务器建立连接或请求进行活动状态检查，并验证响应是否正确。被动为在客户端进行请求或连接时运行状况检查，监视上游服务器的连接或响应。你可能想要使用被动式状态检查来减少上游服务器的负载，并且你可能还想要使用主动式状态检查来确定上游服务器在为客户端提供故障服务之前的故障。本章的最后将讨论如何监视要进行负载均衡的上游应用服务器的运行状态状况。

## 2.1 HTTP负载均衡

### 问题

你需要在两个或多个HTTP服务器之间分配负载。

### 解答

使用NGINX的HTTP模块，通过`upstream`块在HTTP服务器上实现负载均衡：

```
upstream backend {
    server 10.10.12.45:80 weight=1;
    server app.example.com:80 weight=2;
}
server {
    location / {
        proxy_pass http://backend;
    }
}
```
上面的配置均衡了端口80上的两个HTTP服务器之间的负载。`weight`参数指示NGINX将两倍的连接传递给第二个服务器，`weight`参数默认为1。

### 讨论

HTTP `upstream` 模块控制HTTP的负载均衡. 这个模块定义了一个目标池 - Unix套接字，IP地址和DNS记录的任意组合，或混合。`upstream` 模块还定义了如何将任意单独的request请求分配给任何上游服务器。

每个上游目标是通过`server`指令在上游池(upstream pool)中定义的。`server`指令提供了Unix套接字，IP地址或FQDN，以及许多可选参数。可选参数提供了许多对请求路由的控制。这些参数包括平衡算法中服务器的权重（weight）; 服务器是处于待机模式（standby mode），可用（available）还是不可用（unavailable）；以及如何确定服务器是否不可用. NGINX Plus提供了许多其他方便的参数，例如与服务器的连接限制，高级DNS解析控制以及在服务器启动后能够缓慢增加与服务器的连接的能力。

## 2.2 TCP负载均衡

### 问题

你需要在两个或多个TCP服务器之间分配负载。

### 解答

使用NGINX的`stream`模块在TCP服务器上使用`upstream`块进行负载均衡:

```
stream {
    upstream mysql_read {
        server read1.example.com:3306  weight=5;
        server read2.example.com:3306;
        server 10.10.12.34:3306  backup;
    }
    server {
        listen 3306;
        roxy_pass mysql_read;
    }
}
```

本例中的`server`块指示NGINX监听TCP端口3306，并在两个MySQL数据库读副本之间均衡负载，并列出另一个作为备份，如果上面的数据库们宕机则将通过该备份。此配置不能添加到`conf.d`文件夹，因为该文件夹包含在`http`块中; 你应该创建一个名为`stream.conf.d`的文件夹，在`nginx.conf`文件中开启一个新的`stream`块，并将新的流（stream）配置引入到这个文件夹。

### 讨论

TCP负载均衡由NGINX `stream`模块定义。与HTTP模块一样，`stream`模块允许您定义上游服务器池（upstream pools）并配置侦听服务器。在将服务器配置为监听给定端口时，必须定义要监听的端口，或者可选地定义地址和端口。从那里，必须配置一个目的地，不管它是另一个地址的直接反向代理还是上游资源池。

TCP负载平衡的upstream与HTTP的upstream非常相似，因为它将上游(pustream)资源定义为服务器，并使用Unix套接字，IP或完全限定域名（FQDN）进行配置，以及服务器权重，最大连接数， DNS解析器和连接启动周期；以及服务器是处于活动状态，还是处于关闭状态，还是处于备份模式。

NGINX Plus提供了更多用于TCP负载平衡的功能。NGINX Plus中提供的这些高级功能可以在本书中找到。所有负载均衡的运行状况检查将在本章后面介绍。

## 2.3 UDP负载均衡

### 问题

你需要在两个或多个UDP服务器之间分配负载。

### 解答

使用NGINX的`stream`模块在TCP服务器上使用`upstream`块进行负载均衡, UDP服务器的负载:

```
stream {
    upstream ntp {
        server ntp1.example.com:123  weight=2;
        server ntp2.example.com:123;
    }
    server {
        listen 123 udp;
        proxy_pass ntp;
    }
}
```

